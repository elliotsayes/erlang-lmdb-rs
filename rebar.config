%% rebar.config - Rebar3 configuration for LMDB NIF

{erl_opts, [debug_info]}.

{deps, []}.

{plugins, [pc]}.

{artifacts, ["priv/lmdb_nif.so"]}.

{provider_hooks,
 [
  {pre,
   [
    {compile, {pc, compile}},
    {clean, {pc, clean}}
   ]
  }
 ]
}.

{port_compiler, [
    {"priv/lmdb_nif.so", ["c_src/*.c"]}
]}.

{port_env, [
    %% Ensure the LMDB library is built first
    {".*", "CFLAGS", "$CFLAGS -I lmdb-LMDB_0.9.31/libraries/liblmdb -DMDB_USE_ROBUST=0"},
    {".*", "LDFLAGS", "$LDFLAGS lmdb-LMDB_0.9.31/libraries/liblmdb/liblmdb.a"},
    
    %% Platform-specific settings
    {"darwin", "CFLAGS", "$CFLAGS -mmacosx-version-min=10.14"},
    {"darwin", "LDFLAGS", "$LDFLAGS -bundle -flat_namespace -undefined suppress"},
    
    %% Handle Apple Silicon and Intel Macs
    {"darwin.*arm64", "CFLAGS", "$CFLAGS -arch arm64"},
    {"darwin.*arm64", "LDFLAGS", "$LDFLAGS -arch arm64"},
    {"darwin.*x86_64", "CFLAGS", "$CFLAGS -arch x86_64"},
    {"darwin.*x86_64", "LDFLAGS", "$LDFLAGS -arch x86_64"},
    
    %% Use Homebrew paths on macOS if available
    {"darwin", "CFLAGS", "$CFLAGS -I/opt/homebrew/include -I/usr/local/include"},
    {"darwin", "LDFLAGS", "$LDFLAGS -L/opt/homebrew/lib -L/usr/local/lib"},
    
    %% Linux and other Unix systems
    {"(linux|solaris|freebsd|netbsd|openbsd|dragonfly|gnu)",
     "CFLAGS", "$CFLAGS -fPIC"},
    {"(linux|solaris|freebsd|netbsd|openbsd|dragonfly|gnu)",
     "LDFLAGS", "$LDFLAGS -shared -Wl,-rpath,\\$ORIGIN"},
     
    %% Windows
    {"win32", "LDFLAGS", "$LDFLAGS lmdb.lib"}
]}.

{profiles, [
    {test, [
        {deps, [
            {eunit_formatters, "0.5.0"}
        ]},
        {eunit_opts, [
            no_tty,
            {report, {eunit_progress, [colored, profile]}}
        ]}
    ]}
]}.

{pre_hooks, [
    {"darwin", compile, "make deps UNAME_SYS=Darwin"},
    {"linux", compile, "make deps UNAME_SYS=Linux"},
    {"freebsd", compile, "make deps UNAME_SYS=FreeBSD"},
    {".*", compile, "make deps"}
]}.

{post_hooks, [
    {clean, "make clean"}
]}.
