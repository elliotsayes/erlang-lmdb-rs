%% rebar.config - Rebar3 configuration for LMDB NIF

{erl_opts, [debug_info]}.

{deps, []}.

{plugins, [pc]}.

{artifacts, ["priv/lmdb_nif.so"]}.

{provider_hooks,
 [
  {pre,
   [
    {compile, {pc, compile}},
    {clean, {pc, clean}}
   ]
  }
 ]
}.

{port_compiler, [
    {"priv/lmdb_nif.so", ["c_src/*.c"]}
]}.

{port_env, [
    %% Ensure the LMDB library is built first
    {".*", "CFLAGS", "$CFLAGS -I c_src/lmdb-LMDB_0.9.31/libraries/liblmdb"},
    {".*", "LDFLAGS", "$LDFLAGS c_src/lmdb-LMDB_0.9.31/libraries/liblmdb/liblmdb.a"},
    
    %% Platform-specific linker flags
    {"(linux|solaris|freebsd|netbsd|openbsd|dragonfly|gnu)",
     "LDFLAGS", "$LDFLAGS -Wl,-rpath,\\$$ORIGIN"},
    {"darwin", "LDFLAGS", "$LDFLAGS -flat_namespace -undefined suppress"},
    {"win32", "LDFLAGS", "$LDFLAGS lmdb.lib"}
]}.

{profiles, [
    {test, [
        {deps, [
            {eunit_formatters, "0.5.0"}
        ]},
        {eunit_opts, [
            no_tty,
            {report, {eunit_progress, [colored, profile]}}
        ]}
    ]}
]}.

{pre_hooks, [
    {compile, "make deps"}
]}.

{post_hooks, [
    {clean, "make clean"}
]}.
